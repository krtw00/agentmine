# Observable Facts（観測可能な事実）

## 目的

ステータス判定の原則を定義する。本ドキュメントはObservable Facts原則のSSoT（Single Source of Truth）である。

## 背景

従来のタスク管理では、人間やAIが主観的に「完了」と設定する。これは設定漏れや判断基準のばらつきを招く。

**なぜObservable Factsか:**
- 誰が見ても同じ結果になる（一貫性）
- 人間の介入なしに判定可能（自動化）
- 事実ベースで改ざん不可（信頼性）

## 設計原則

ステータスはexit code、merge状態等の客観事実で判定する。主観的な設定は行わない。

## 主観的判定 vs 客観的判定

| 観点 | 主観的判定 | 客観的判定 |
|------|-----------|-----------|
| 判定者 | 人間/AIが設定 | AgentMineが自動判定 |
| 基準 | 人によって異なる | 誰が見ても同じ |
| 設定漏れ | 発生する | 発生しない |
| 改ざん | 可能 | 不可能 |
| 例 | 「完了したので done に設定」 | 「ブランチがマージ済み → done」 |

## 観測可能な事実の例

### Worker終了

| 観測対象 | 方法 | 判定 |
|---------|------|------|
| プロセス終了 | exit code | 0=成功、≠0=失敗 |
| シグナル | signal | SIGTERM/SIGKILL等 |

### タスク完了

| 観測対象 | 方法 | 判定 |
|---------|------|------|
| ブランチマージ | git log baseBranch..taskBranch | 空=マージ済み=done |

**Git判定の仕組み:**
セッションブランチがベースブランチにマージ済みかどうかをgit logで判定する。結果が空ならマージ済み。GitHub/GitLab/Bitbucket等のプラットフォームに依存しない。

### セッション状態

| 観測対象 | 方法 | 判定 |
|---------|------|------|
| プロセス存在 | ps -p PID | 存在=running、不存在=completed/failed |
| 終了時刻 | completedAtの有無 | あり=終了、なし=実行中 |

### DoD検証

| 観測対象 | 方法 | 判定 |
|---------|------|------|
| lint/test/build | exit code | 0=passed、≠0=failed |

## タスクステータスの自動判定

### ステータス定義

| ステータス | 条件（Observable Facts） |
|-----------|------------------------|
| open | セッションなし |
| in_progress | runningセッションが1つ以上 |
| done | ブランチがマージ済み（git log結果が空） |
| dod_failed | DoD検証失敗 |
| failed | runningなし、mergedなし、失敗/取消のみ |
| cancelled | 手動キャンセル（唯一の例外） |

### 判定優先順位

| 順位 | 条件 | 結果 |
|------|------|------|
| 1 | 手動キャンセル | cancelled |
| 2 | ブランチマージ済み | done |
| 3 | DoD検証失敗 | dod_failed |
| 4 | runningセッション存在 | in_progress |
| 5 | 全セッション失敗/取消 | failed |
| 6 | セッションなし | open |

## セッションステータスの自動判定

| ステータス | 条件 |
|-----------|------|
| running | プロセス存在、completedAtなし |
| completed | exit code = 0 |
| failed | exit code ≠ 0、またはプロセス異常終了 |
| cancelled | 手動停止 |

## 主観的判定との比較

### 従来のタスク管理の問題

| 問題 | 説明 |
|------|------|
| 設定忘れ | 担当者が「完了」設定を忘れる |
| 基準の曖昧さ | 「完了」の意味が人によって違う |
| 不整合 | 実際の状態とステータスが一致しない |

### Observable Factsの利点

| 利点 | 説明 |
|------|------|
| 設定忘れなし | マージされたら自動的にdone |
| 基準が明確 | done = マージされた（事実） |
| 常に一致 | 事実と常にステータスが一致 |

## 唯一の例外: cancelled

cancelledステータスは唯一の主観的判定。

| 理由 | 説明 |
|------|------|
| 意思決定 | キャンセルは観測可能な事実では判定できない |
| 明示的操作 | 人間またはOrchestratorが明示的に決定 |

## メリット・デメリット

### メリット

| メリット | 説明 |
|---------|------|
| 一貫性 | 誰が見ても同じ結果 |
| 自動化 | 人間の介入不要 |
| 信頼性 | 事実ベースで改ざん不可 |
| 明確性 | ステータスの意味が曖昧でない |
| 並列対応 | 複数人/AIが同時作業しても問題なし |

### デメリット

| デメリット | 対策 |
|-----------|------|
| 柔軟性の制限 | cancelledで明示的に変更可能 |
| Git依存 | Git外の作業は対象外 |
| 学習コスト | ドキュメントで説明 |

## よくある質問

| 質問 | 回答 |
|------|------|
| タスクステータスを手動更新できる？ | いいえ。マージすれば自動的にdoneになる |
| タスクがdoneにならない | ブランチがマージされていない。git mergeを実行する |
| DoD判定がpendingのまま | Orchestratorがマージ実行時に記録される |

## 設計判断基準

新機能追加時は以下を確認:
- ステータスは観測可能な事実で判定しているか？
- 主観的な設定に依存していないか？
- 誰が見ても同じ結果になるか？
- 自動化可能か？

## 関連ドキュメント

- アーキテクチャ: @02-architecture/architecture.md
- データモデル: @04-data/data-model.md
- Worker実行フロー: @07-runtime/worker-lifecycle.md
- 用語集: @appendix/glossary.md
