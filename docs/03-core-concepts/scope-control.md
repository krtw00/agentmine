# ã‚¹ã‚³ãƒ¼ãƒ—åˆ¶å¾¡

ğŸ¯ **å®‰å…¨æ€§ã®è¦**: WorkerãŒã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç‰©ç†çš„ã«åˆ¶é™ã™ã‚‹ä»•çµ„ã¿

agentmineã¯**ã‚¹ã‚³ãƒ¼ãƒ—åˆ¶å¾¡**ã«ã‚ˆã‚Šã€WorkerãŒã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç‰©ç†çš„ã«åˆ¶é™ã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€AIã«è‡ªå‹•æ‰¿èªãƒ¢ãƒ¼ãƒ‰ã§å®‰å…¨ã«ä½œæ¥­ã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

---

## åŸå‰‡

**ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§å…¨ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿å–ã‚Šå¯èƒ½ã€‚excludeã§é™¤å¤–ã€writeã§ç·¨é›†è¨±å¯ã‚’æ˜ç¤ºçš„ã«åˆ¶å¾¡ã€‚**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ã‚¹ã‚³ãƒ¼ãƒ—åˆ¶å¾¡ã®éšå±¤                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  ã€æœ€å„ªå…ˆã€‘exclude                                            â”‚
â”‚    â†’ sparse-checkoutã§ç‰©ç†çš„ã«é™¤å¤–ï¼ˆå­˜åœ¨ã—ãªã„ï¼‰             â”‚
â”‚                                                              â”‚
â”‚  ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã€‘read: ã™ã¹ã¦ï¼ˆexcludeã‚’é™¤ãï¼‰                  â”‚
â”‚    â†’ worktreeã«å­˜åœ¨ã€å‚ç…§å¯èƒ½                                 â”‚
â”‚    â†’ æ˜ç¤ºçš„ãªreadæŒ‡å®šã¯ä»»æ„ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: ã™ã¹ã¦ï¼‰             â”‚
â”‚                                                              â”‚
â”‚  ã€æ˜ç¤ºçš„ã€‘write                                              â”‚
â”‚    â†’ æ˜ç¤ºçš„ã«æŒ‡å®šã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ç·¨é›†å¯èƒ½                    â”‚
â”‚    â†’ ãã‚Œä»¥å¤–ã¯ chmod a-w ã§èª­ã¿å–ã‚Šå°‚ç”¨                     â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ãªãœã‚¹ã‚³ãƒ¼ãƒ—åˆ¶å¾¡ãŒå¿…è¦ã‹

### 1. æ„å›³ã—ãªã„å¤‰æ›´ã®é˜²æ­¢

WorkerãŒèª¤ã£ã¦é‡è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚’å¤‰æ›´ã™ã‚‹ã®ã‚’é˜²ãï¼š

```
âŒ ã‚¹ã‚³ãƒ¼ãƒ—åˆ¶å¾¡ãªã—:
Workerã€Œã‚¿ã‚¹ã‚¯: ãƒ­ã‚°ã‚¤ãƒ³æ©Ÿèƒ½å®Ÿè£…ã€
â†’ ã†ã£ã‹ã‚Š.envãƒ•ã‚¡ã‚¤ãƒ«ã‚’å¤‰æ›´
â†’ æœ¬ç•ªAPIã‚­ãƒ¼ãŒæ¼æ´©

âœ… ã‚¹ã‚³ãƒ¼ãƒ—åˆ¶å¾¡ã‚ã‚Š:
Workerã€Œã‚¿ã‚¹ã‚¯: ãƒ­ã‚°ã‚¤ãƒ³æ©Ÿèƒ½å®Ÿè£…ã€
â†’ .envã¯å­˜åœ¨ã—ãªã„ï¼ˆexcludeï¼‰
â†’ å¤‰æ›´ä¸å¯èƒ½
```

### 2. è‡ªå‹•æ‰¿èªãƒ¢ãƒ¼ãƒ‰ã®å®Ÿç¾

ç‰©ç†çš„ã«åˆ¶é™ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€AIã«è‡ªå‹•æ‰¿èªã§ä½œæ¥­ã•ã›ã‚‰ã‚Œã‚‹ï¼š

```bash
# ã‚¹ã‚³ãƒ¼ãƒ—åˆ¶å¾¡ãªã— â†’ äººé–“ã®æ‰¿èªãŒå¿…è¦
claude-code exec "ãƒ­ã‚°ã‚¤ãƒ³æ©Ÿèƒ½å®Ÿè£…"
# ã€Œ.envã‚’ç·¨é›†ã—ã¾ã™ã‹ï¼Ÿã€â†’ äººé–“ãŒåˆ¤æ–­

# ã‚¹ã‚³ãƒ¼ãƒ—åˆ¶å¾¡ã‚ã‚Š â†’ è‡ªå‹•æ‰¿èªã§å®Ÿè¡Œå¯èƒ½
claude-code exec --dangerously-skip-permissions "ãƒ­ã‚°ã‚¤ãƒ³æ©Ÿèƒ½å®Ÿè£…"
# .envã¯å­˜åœ¨ã—ãªã„ã®ã§ã€ç·¨é›†ã•ã‚Œã‚‹å¿ƒé…ãªã—
```

### 3. ä¸¦åˆ—å®Ÿè¡Œã®å®‰å…¨æ€§

è¤‡æ•°ã®WorkerãŒäº’ã„ã«å¹²æ¸‰ã—ãªã„ï¼š

```
Worker Aï¼ˆã‚¿ã‚¹ã‚¯: èªè¨¼APIï¼‰
scope: src/auth/

Worker Bï¼ˆã‚¿ã‚¹ã‚¯: æ±ºæ¸ˆAPIï¼‰
scope: src/payment/

â†’ äº’ã„ã«å¹²æ¸‰ã—ãªã„ï¼ˆç‰©ç†çš„ã«åˆ†é›¢ï¼‰
```

---

## ã‚¹ã‚³ãƒ¼ãƒ—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰

### ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å®šç¾©

| ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ | èª¬æ˜ | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ | ç‰©ç†çš„å®Ÿè£… |
|-----------|------|------------|-----------|
| `exclude` | ã‚¢ã‚¯ã‚»ã‚¹ä¸å¯ | `[]`ï¼ˆãªã—ï¼‰ | sparse-checkoutã§é™¤å¤–ï¼ˆå­˜åœ¨ã—ãªã„ï¼‰ |
| `read` | å‚ç…§å¯èƒ½ | `["**/*"]`ï¼ˆã™ã¹ã¦ï¼‰ | worktreeã«å­˜åœ¨ |
| `write` | ç·¨é›†å¯èƒ½ | `[]`ï¼ˆãªã—ï¼‰ | æ˜ç¤ºçš„ã«æŒ‡å®šã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ |
| ï¼ˆæš—é»™ï¼‰ | readå¯¾è±¡ - writeå¯¾è±¡ - excludeå¯¾è±¡ | - | chmod a-w ã§èª­ã¿å–ã‚Šå°‚ç”¨ |

### å„ªå…ˆé †ä½

```
exclude â†’ readï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: ã™ã¹ã¦ï¼‰ â†’ write
```

**è©•ä¾¡ãƒ­ã‚¸ãƒƒã‚¯**:
1. **exclude ã«ãƒãƒƒãƒ â†’ é™¤å¤–**ï¼ˆsparse-checkoutï¼‰
2. exclude ã§ãªã„ && **read ã«ãƒãƒƒãƒï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: ã™ã¹ã¦ï¼‰â†’ å‚ç…§å¯èƒ½**ï¼ˆå­˜åœ¨ï¼‰
3. exclude ã§ãªã„ && read ã«ãƒãƒƒãƒ && **write ã«ãƒãƒƒãƒ â†’ ç·¨é›†å¯èƒ½**
4. exclude ã§ãªã„ && read ã«ãƒãƒƒãƒ && **write ã«éãƒãƒƒãƒ â†’ èª­ã¿å–ã‚Šå°‚ç”¨**ï¼ˆchmod a-wï¼‰

**é‡è¦**: `read`ã‚’çœç•¥ã—ãŸå ´åˆã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§`["**/*"]`ï¼ˆexcludeã‚’é™¤ãå…¨ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰ãŒé©ç”¨ã•ã‚Œã¾ã™ã€‚

---

## Agentå®šç¾©ä¾‹

### åŸºæœ¬ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆreadçœç•¥ - æ¨å¥¨ï¼‰

```yaml
name: coder
client: claude-code
model: sonnet
scope:
  exclude:                 # é™¤å¤–ï¼ˆã“ã‚Œä»¥å¤–ã¯è‡ªå‹•çš„ã«èª­ã¿å–ã‚Šå¯èƒ½ï¼‰
    - "**/*.env"          # ã™ã¹ã¦ã®.envãƒ•ã‚¡ã‚¤ãƒ«
    - "**/secrets/**"      # secretsãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªé…ä¸‹ã™ã¹ã¦
    - "**/.aws/**"         # AWSèªè¨¼æƒ…å ±
    - "**/node_modules/**" # ä¾å­˜ãƒ©ã‚¤ãƒ–ãƒ©ãƒª

  # read: çœç•¥å¯èƒ½ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: excludeã‚’é™¤ãå…¨ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰

  write:                   # ç·¨é›†å¯èƒ½ï¼ˆæ˜ç¤ºçš„ã«æŒ‡å®šï¼‰
    - "src/**"             # srcãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªé…ä¸‹
    - "tests/**"           # testsãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªé…ä¸‹
    - "package.json"       # package.json
```

### æ˜ç¤ºçš„readãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆç‰¹å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿å‚ç…§ã•ã›ãŸã„å ´åˆï¼‰

```yaml
name: reviewer
client: claude-code
model: sonnet
scope:
  exclude:
    - "**/*.env"
    - "**/node_modules/**"

  read:                    # æ˜ç¤ºçš„ã«å‚ç…§å¯èƒ½ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é™å®š
    - "src/**"
    - "docs/**"
    - "README.md"

  write: []                # èª­ã¿å–ã‚Šå°‚ç”¨Workerï¼ˆç·¨é›†ä¸å¯ï¼‰
```

---

## ç‰©ç†çš„å®Ÿè£…

### 1. Git Sparse Checkoutï¼ˆexcludeï¼‰

**ç›®çš„**: exclude ã«ãƒãƒƒãƒã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç‰©ç†çš„ã«é™¤å¤–

```bash
cd .agentmine/worktrees/task-5

# sparse-checkoutåˆæœŸåŒ–
git sparse-checkout init --cone

# excludeãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’é™¤å¤–ã—ã¤ã¤ã€readãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å«ã‚ã‚‹
git sparse-checkout set --no-cone '/*' '!**/*.env' '!**/secrets/**'

# çµæœ: .envãƒ•ã‚¡ã‚¤ãƒ«ã¯ç‰©ç†çš„ã«å­˜åœ¨ã—ãªã„
ls -la
# â†’ .env ãŒå­˜åœ¨ã—ãªã„
```

**åŠ¹æœ**:
- Workerå´ã§ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ãˆãªã„
- ç·¨é›†ã—ã‚ˆã†ã¨ã—ã¦ã‚‚ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ãªã„
- AIãŒèª¤ã£ã¦å¤‰æ›´ã™ã‚‹ã“ã¨ãŒä¸å¯èƒ½

### 2. chmodï¼ˆread-onlyåŒ–ï¼‰

**ç›®çš„**: write ã«å«ã¾ã‚Œãªã„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿å–ã‚Šå°‚ç”¨åŒ–

```bash
cd .agentmine/worktrees/task-5

# writeå¯¾è±¡å¤–ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿å–ã‚Šå°‚ç”¨ã«
find . -type f \
  ! -path './src/*' \
  ! -path './tests/*' \
  ! -name 'package.json' \
  -exec chmod a-w {} \;

# çµæœ: docs/é…ä¸‹ã¯èª­ã¿å–ã‚Šå°‚ç”¨
ls -la docs/
# â†’ -r--r--r-- (æ›¸ãè¾¼ã¿æ¨©é™ãªã—)
```

**åŠ¹æœ**:
- Workerã¯å‚ç…§å¯èƒ½
- ç·¨é›†ã—ã‚ˆã†ã¨ã™ã‚‹ã¨Permission Denied
- AIãŒèª¤ã£ã¦å¤‰æ›´ã—ã«ãã„

---

## Workerèµ·å‹•æ™‚ã®é©ç”¨ãƒ•ãƒ­ãƒ¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  agentmine worker run 5 --exec                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ 1. Git Worktreeä½œæˆ  â”‚
         â”‚  .agentmine/         â”‚
         â”‚  worktrees/task-5/   â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ 2. DB ã‹ã‚‰Agentå®šç¾©  â”‚
         â”‚  å–å¾—ï¼ˆscopeå«ã‚€ï¼‰   â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ 3. Sparse Checkout   â”‚
         â”‚  excludeé©ç”¨         â”‚
         â”‚  ï¼ˆç‰©ç†çš„ã«é™¤å¤–ï¼‰     â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ 4. chmodé©ç”¨         â”‚
         â”‚  writeå¯¾è±¡å¤–ã‚’       â”‚
         â”‚  èª­ã¿å–ã‚Šå°‚ç”¨åŒ–       â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ 5. Worker AIèµ·å‹•     â”‚
         â”‚  è‡ªå‹•æ‰¿èªãƒ¢ãƒ¼ãƒ‰       â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ 6. ã‚³ãƒ¼ãƒ‰ä½œæˆãƒ»ç·¨é›†   â”‚
         â”‚  ï¼ˆã‚¹ã‚³ãƒ¼ãƒ—å†…ã®ã¿ï¼‰   â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ 7. Workerå®Œäº†        â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ 8. äº‹å¾Œãƒã‚§ãƒƒã‚¯       â”‚
         â”‚  git diff ã§æ¤œè¨¼     â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## äº‹å¾Œãƒã‚§ãƒƒã‚¯ï¼ˆæ¤œè¨¼ï¼‰

ã‚¹ã‚³ãƒ¼ãƒ—åˆ¶å¾¡ã¯ç‰©ç†çš„åˆ¶é™ã ãŒã€100%é˜²ã’ã‚‹ã‚ã‘ã§ã¯ãªã„ã€‚äº‹å¾Œãƒã‚§ãƒƒã‚¯ã§æ¤œè¨¼ã™ã‚‹ã€‚

### ãƒã‚§ãƒƒã‚¯å†…å®¹

```typescript
// Workerå®Œäº†å¾Œã€agentmineãŒè‡ªå‹•å®Ÿè¡Œ

// 1. å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§å–å¾—
const changedFiles = await exec('git diff --name-only HEAD');

// 2. ã‚¹ã‚³ãƒ¼ãƒ—é•åãƒã‚§ãƒƒã‚¯
const violations = changedFiles.filter(file => {
  // excludeã«ãƒãƒƒãƒ â†’ é•å
  if (matchesExclude(file, agent.scope.exclude)) {
    return true;
  }

  // writeã«å«ã¾ã‚Œãªã„ â†’ é•å
  if (!matchesWrite(file, agent.scope.write)) {
    return true;
  }

  return false;
});

// 3. é•åãŒã‚ã‚Œã°ã‚¨ãƒ©ãƒ¼
if (violations.length > 0) {
  throw new ScopeViolationError(violations);
}
```

### é•åæ™‚ã®å‹•ä½œ

```bash
# Workerå®Œäº†
agentmine worker done 5

# ã‚¹ã‚³ãƒ¼ãƒ—é•åæ¤œå‡º
Error: Scope violation detected
- .env (excluded)
- docs/architecture.md (not in write scope)

# ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ failed ã«è¨˜éŒ²
# Orchestratorã«é€šçŸ¥
```

---

## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¸Šã®è€ƒæ…®äº‹é …

### æ”»æ’ƒãƒ™ã‚¯ãƒˆãƒ«ã¨å¯¾ç­–

| æ”»æ’ƒãƒ™ã‚¯ãƒˆãƒ« | ã‚¹ã‚³ãƒ¼ãƒ—åˆ¶å¾¡ã®åŠ¹æœ | äº‹å¾Œãƒã‚§ãƒƒã‚¯ |
|-------------|-------------------|-------------|
| `chmod u+w` ã§æ›¸ãè¾¼ã¿æ¨©é™å¾©å…ƒ | é˜²ã’ãªã„ | æ¤œå‡ºå¯èƒ½ |
| `git sparse-checkout disable` | é˜²ã’ãªã„ | æ¤œå‡ºå¯èƒ½ |
| ç›´æ¥ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆï¼ˆecho > .envï¼‰ | é˜²ã’ãªã„ | æ¤œå‡ºå¯èƒ½ |
| ã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯ã§è¿‚å› | é˜²ã’ãªã„ | æ¤œå‡ºå¯èƒ½ |

### å¤šå±¤é˜²å¾¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ãƒ¬ã‚¤ãƒ¤ãƒ¼1: sparse-checkout + chmod                          â”‚
â”‚    â†’ èª¤æ“ä½œãƒ»ã†ã£ã‹ã‚ŠãƒŸã‚¹ã‚’é˜²ã                              â”‚
â”‚    â†’ AIãŒã€Œè‡ªç„¶ã«ã€å®ˆã‚‹                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ãƒ¬ã‚¤ãƒ¤ãƒ¼2: äº‹å¾Œãƒã‚§ãƒƒã‚¯ï¼ˆgit diffï¼‰                         â”‚
â”‚    â†’ æ„å›³çš„ãªå›é¿ã‚’æ¤œå‡º                                      â”‚
â”‚    â†’ æ‚ªæ„ã‚ã‚‹Agentãƒ»AIã‚’æ¤œå‡º                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ãƒ¬ã‚¤ãƒ¤ãƒ¼3: Orchestratorã«ã‚ˆã‚‹æ¤œè¨¼                           â”‚
â”‚    â†’ DoDæ¤œè¨¼ï¼ˆlint, test, buildï¼‰                           â”‚
â”‚    â†’ ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## worktreeä¾‹

### ã‚¹ã‚³ãƒ¼ãƒ—é©ç”¨å‰

```
.agentmine/worktrees/task-5/
â”œâ”€â”€ .env                    # å­˜åœ¨ã™ã‚‹
â”œâ”€â”€ .aws/
â”‚   â””â”€â”€ credentials         # å­˜åœ¨ã™ã‚‹
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ auth.ts
â”‚   â””â”€â”€ payment.ts
â”œâ”€â”€ tests/
â”‚   â””â”€â”€ auth.test.ts
â”œâ”€â”€ docs/
â”‚   â””â”€â”€ architecture.md
â”œâ”€â”€ package.json
â””â”€â”€ README.md
```

### ã‚¹ã‚³ãƒ¼ãƒ—é©ç”¨å¾Œ

```yaml
scope:
  exclude:
    - "**/*.env"
    - "**/.aws/**"
  read:
    - "**/*"
  write:
    - "src/**"
    - "tests/**"
    - "package.json"
```

```
.agentmine/worktrees/task-5/
# .env â†’ å­˜åœ¨ã—ãªã„ï¼ˆsparse-checkouté™¤å¤–ï¼‰
# .aws/ â†’ å­˜åœ¨ã—ãªã„ï¼ˆsparse-checkouté™¤å¤–ï¼‰
â”œâ”€â”€ src/                    # writeå¯èƒ½
â”‚   â”œâ”€â”€ auth.ts
â”‚   â””â”€â”€ payment.ts
â”œâ”€â”€ tests/                  # writeå¯èƒ½
â”‚   â””â”€â”€ auth.test.ts
â”œâ”€â”€ docs/                   # read-only (chmod a-w)
â”‚   â””â”€â”€ architecture.md     # -r--r--r--
â”œâ”€â”€ package.json            # writeå¯èƒ½
â””â”€â”€ README.md               # read-only (chmod a-w)
```

---

## å®Ÿè£…ä¾‹

### ã‚¹ã‚³ãƒ¼ãƒ—é©ç”¨ï¼ˆTypeScriptï¼‰

```typescript
import { exec } from 'node:child_process';
import { promisify } from 'node:util';
import minimatch from 'minimatch';

const execAsync = promisify(exec);

async function applyScopeControl(
  worktreePath: string,
  scope: AgentScope
) {
  // 1. sparse-checkouté©ç”¨
  await applySparseCheckout(worktreePath, scope);

  // 2. chmodé©ç”¨ï¼ˆwriteå¯¾è±¡å¤–ã‚’èª­ã¿å–ã‚Šå°‚ç”¨åŒ–ï¼‰
  await applyChmod(worktreePath, scope);
}

async function applySparseCheckout(
  worktreePath: string,
  scope: AgentScope
) {
  const cwd = worktreePath;

  // sparse-checkoutåˆæœŸåŒ–
  await execAsync('git sparse-checkout init --cone', { cwd });

  // excludeãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å¦å®šå½¢ã«å¤‰æ›
  const negatedPatterns = scope.exclude.map(p => `!${p}`);

  // readãƒ‘ã‚¿ãƒ¼ãƒ³ã¨excludeã®å¦å®šå½¢ã‚’çµ„ã¿åˆã‚ã›
  const patterns = [...scope.read, ...negatedPatterns];

  // sparse-checkoutè¨­å®š
  await execAsync(
    `git sparse-checkout set --no-cone ${patterns.join(' ')}`,
    { cwd }
  );
}

async function applyChmod(
  worktreePath: string,
  scope: AgentScope
) {
  // writeå¯¾è±¡å¤–ã®ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§å–å¾—
  const { stdout } = await execAsync('git ls-files', { cwd: worktreePath });
  const files = stdout.trim().split('\n');

  for (const file of files) {
    // writeã«ãƒãƒƒãƒã—ãªã„ â†’ èª­ã¿å–ã‚Šå°‚ç”¨åŒ–
    const isWritable = scope.write.some(pattern =>
      minimatch(file, pattern, { dot: true })
    );

    if (!isWritable) {
      const filePath = path.join(worktreePath, file);

      if (process.platform === 'win32') {
        await execAsync(`attrib +R "${filePath}"`);
      } else {
        await execAsync(`chmod a-w "${filePath}"`);
      }
    }
  }
}
```

### äº‹å¾Œãƒã‚§ãƒƒã‚¯ï¼ˆTypeScriptï¼‰

```typescript
async function verifyScopeCompliance(
  worktreePath: string,
  scope: AgentScope
): Promise<string[]> {
  const cwd = worktreePath;

  // å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§å–å¾—
  const { stdout } = await execAsync('git diff --name-only HEAD', { cwd });
  const changedFiles = stdout.trim().split('\n').filter(Boolean);

  const violations: string[] = [];

  for (const file of changedFiles) {
    // excludeã«ãƒãƒƒãƒ â†’ é•å
    if (scope.exclude.some(p => minimatch(file, p, { dot: true }))) {
      violations.push(`${file} (excluded)`);
      continue;
    }

    // writeã«å«ã¾ã‚Œãªã„ â†’ é•å
    if (!scope.write.some(p => minimatch(file, p, { dot: true }))) {
      violations.push(`${file} (not in write scope)`);
    }
  }

  return violations;
}
```

---

## åˆ¶é™äº‹é …

### 1. çµ¶å¯¾çš„ãªé˜²å¾¡ã§ã¯ãªã„

ç‰©ç†çš„åˆ¶é™ã¯ã€Œèª¤æ“ä½œé˜²æ­¢ã€ãŒä¸»ç›®çš„ã€‚æ‚ªæ„ã‚ã‚‹å›é¿ã¯äº‹å¾Œãƒã‚§ãƒƒã‚¯ã§æ¤œå‡ºã€‚

### 2. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å½±éŸ¿

sparse-checkout + chmod ã¯å¤§è¦æ¨¡ãƒªãƒã‚¸ãƒˆãƒªã§é…ããªã‚‹å¯èƒ½æ€§ã€‚

### 3. Windowsç’°å¢ƒ

chmod ã®ä»£ã‚ã‚Šã« attrib ã‚’ä½¿ç”¨ã€‚å®Œå…¨ãªäº’æ›æ€§ã¯ãªã„ã€‚

---

## ã‚ˆãã‚ã‚‹è³ªå•

### Q1: Worker ãŒ chmod u+w ã§æ›¸ãè¾¼ã¿æ¨©é™ã‚’å¾©å…ƒã—ãŸã‚‰ï¼Ÿ

**A**: äº‹å¾Œãƒã‚§ãƒƒã‚¯ã§æ¤œå‡ºã•ã‚Œã¾ã™ã€‚agentmineãŒWorkerå®Œäº†æ™‚ã«`git diff`ã§å¤‰æ›´ã‚’ç¢ºèªã—ã€writeç¯„å›²å¤–ã®å¤‰æ›´ãŒã‚ã‚Œã°ã‚¨ãƒ©ãƒ¼ã¨ã—ã¦è¨˜éŒ²ã—ã¾ã™ã€‚

### Q2: Worker ãŒ git sparse-checkout disable ã—ãŸã‚‰ï¼Ÿ

**A**: åŒæ§˜ã«äº‹å¾Œãƒã‚§ãƒƒã‚¯ã§æ¤œå‡ºã•ã‚Œã¾ã™ã€‚excludeå¯¾è±¡ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒå¤‰æ›´ã•ã‚Œã¦ã„ã‚Œã°é•åã¨ã—ã¦æ‰±ã‚ã‚Œã¾ã™ã€‚

### Q3: ã‚¹ã‚³ãƒ¼ãƒ—ã‚’å³ã—ãã—éãã‚‹ã¨ä½œæ¥­ã§ããªã„ã®ã§ã¯ï¼Ÿ

**A**: ã¯ã„ã€‚ã‚¹ã‚³ãƒ¼ãƒ—ã¯é©åˆ‡ã«è¨­å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã‚¿ã‚¹ã‚¯ã®æ€§è³ªã«å¿œã˜ã¦ã€Agentå®šç¾©ã‚’ä½¿ã„åˆ†ã‘ã‚‹ã“ã¨ã‚’æ¨å¥¨ã—ã¾ã™ï¼š
- `coder`: åºƒã„ç¯„å›²ã§ä½œæ¥­ï¼ˆsrc/, tests/ï¼‰
- `reviewer`: èª­ã¿å–ã‚Šå°‚ç”¨ï¼ˆwrite: []ï¼‰
- `docs-writer`: docs/ã®ã¿ç·¨é›†å¯èƒ½

### Q4: read ã«ã‚‚ write ã«ã‚‚å«ã¾ã‚Œãªã„ãƒ•ã‚¡ã‚¤ãƒ«ã¯ï¼Ÿ

**A**: sparse-checkoutã§é™¤å¤–ã•ã‚Œã¾ã™ï¼ˆå­˜åœ¨ã—ãªã„ï¼‰ã€‚read ã«å«ã‚ãªã„å ´åˆã€Workerã¯å‚ç…§ã™ã‚‰ã§ãã¾ã›ã‚“ã€‚

---

## é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- @../02-architecture/design-principles.md - Isolation & SafetyåŸå‰‡
- @../05-features/worktree-scope.md - å®Ÿè£…è©³ç´°
- @../05-features/agent-definition.md - Agentå®šç¾©ã®scopeè¨­å®š
- @../07-runtime/worker-lifecycle.md - Workerèµ·å‹•ãƒ•ãƒ­ãƒ¼
- @../appendix/glossary.md - ç”¨èªå®šç¾©ï¼ˆscopeï¼‰
