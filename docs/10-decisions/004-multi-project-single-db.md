# ADR-004: 複数プロジェクト・単一DB

## ステータス

**Accepted** - 2025-01

## コンテキスト

AgentMineで複数のGitHubリポジトリ（プロジェクト）を管理する際のアーキテクチャを決定する必要がある。

### 検討した選択肢

| 選択肢 | 概要 | メリット | デメリット |
|--------|------|----------|------------|
| A: 1プロジェクト=1DB | 各リポジトリに.agentmine/data.db | 完全隔離、シンプル | 横断管理不可、複数UI必要 |
| B: 複数プロジェクト=1DB | グローバルDBで全プロジェクト管理 | 横断分析、一元管理 | projectIdフィルタ必須 |

### ユースケース

開発者が複数のGitHubリポジトリを並列開発する場合：

| 選択肢 | 構成 | 課題 |
|--------|------|------|
| A | repo-A/.agentmine/data.db → Web UI :3001 ... | 管理コストが高い |
| B | ~/.agentmine/data.db → Web UI :3000 (全プロジェクト横断) | 一元管理可能 |

## 決定

**B: 複数プロジェクト=単一DB** を採用する。

### DB配置

| 用途 | データベース | 設定 |
|------|-------------|------|
| 個人利用（デフォルト） | SQLite | ~/.agentmine/data.db |
| チーム利用 | PostgreSQL | 環境変数 AGENTMINE_DATABASE_URL |

### ディレクトリ構成

| パス | 説明 |
|------|------|
| ~/.agentmine/config.yaml | グローバル設定 |
| ~/.agentmine/data.db | SQLite（デフォルト） |
| ~/.agentmine/cache/ | プロジェクトメタデータキャッシュ |

## 理由

### 1. 管理コストの削減

複数プロジェクトを1つのWeb UIで確認できる。プロジェクトフィルタで切り替え可能。

### 2. Redmine的運用との整合性

AgentMineの設計思想「Redmine的運用」に合致：

| ツール | 構成 |
|--------|------|
| Redmine | 1インスタンス = 複数プロジェクト |
| AgentMine | 1DB = 複数プロジェクト |

### 3. SQLite/PostgreSQL両対応

Drizzle ORM（ADR-003）により、接続先の切り替えが容易。

### 4. スキーマの対応

現在のスキーマは既に projectId を持っている。

## 結果

### ポジティブ

| 結果 | 説明 |
|------|------|
| 単一UI管理 | 複数プロジェクトを単一UIで管理可能 |
| 横断分析 | プロジェクト横断の分析・レポートが可能 |
| セットアップ | セットアップがシンプル（グローバルDB自動作成） |
| 柔軟性 | 個人利用はSQLite、チーム利用はPostgreSQLと使い分け可能 |

### ネガティブ

| 結果 | 説明 |
|------|------|
| フィルタ必須 | 全クエリでprojectIdフィルタが必要 |
| 論理分離 | プロジェクト間のデータ分離は論理的（物理的ではない） |
| 障害影響 | グローバルDBの破損は全プロジェクトに影響 |

### リスク

| リスク | 対策 |
|--------|------|
| SQLiteの同時アクセス制限 | 単一ユーザーなら問題なし |
| DBファイルサイズの肥大化 | 長期運用時の監視が必要 |

## 実装計画

### Phase 1: グローバルDB対応

| 手順 | 内容 |
|------|------|
| 1 | DB配置を ~/.agentmine/data.db に変更 |
| 2 | agentmine project add コマンド追加 |
| 3 | 全クエリに projectId フィルタ追加 |

### Phase 2: Web UI対応

| 手順 | 内容 |
|------|------|
| 1 | プロジェクト選択UI追加 |
| 2 | プロジェクト横断ダッシュボード |
| 3 | プロジェクトフィルタ機能 |

### Phase 3: PostgreSQL対応

| 手順 | 内容 |
|------|------|
| 1 | 環境変数による接続先切り替え |
| 2 | PostgreSQLスキーマ生成 |
| 3 | マイグレーション対応 |

## 参考資料

- ADR-002: SQLite as Default Database
- ADR-003: Drizzle ORM
